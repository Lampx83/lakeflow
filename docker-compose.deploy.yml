# Override dùng khi deploy lên server (chạy cùng docker-compose.yml)
# Ví dụ: docker compose -f docker-compose.yml -f docker-compose.deploy.yml up -d --build
#
# Data lake path (no sudo):
#   Default: LAKEFLOW_DATA_PATH=$REPO_DIR/data (set in deploy workflow)
#   Server custom: export LAKEFLOW_DATA_PATH=/datalake/research (create dir with sudo once, then deploy user needs rwx)
#
# - Backend: bỏ mount source, bỏ --reload
# - Frontend: bỏ mount ./backend

services:
  lakeflow-backend:
    volumes:
      - lakeflow_data:/data
    command: uvicorn lakeflow.main:app --host 0.0.0.0 --port 8011
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s

  lakeflow-frontend:
    volumes:
      - lakeflow_data:/data

# Bind volume to LAKEFLOW_DATA_PATH (default: repo/data, no sudo) or set on server for e.g. /datalake/research
volumes:
  lakeflow_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LAKEFLOW_DATA_PATH:-./data}